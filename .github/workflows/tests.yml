name: "Tests"

on:
  push:
    branches: [ "main" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]
  schedule:
    - cron: '30 8 * * *'

jobs:
  test-swebench:
    name: "Testing SWE-Bench"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        language: [ "python" ]
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/test-if-changes
        with:
          name: swebench
          test-files: "tests/gym/envs/test_swe_bench.py"
          changed-files: |
            debug_gym/gym/envs/swe_bench.py
            tests/gym/envs/test_swe_bench.py

  test-swesmith:
    name: "Testing SWE-Smith"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        language: [ "python" ]
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/test-if-changes
        with:
          name: swesmith
          test-files: "tests/gym/envs/test_swe_smith.py"
          changed-files: |
            debug_gym/gym/envs/swe_smith.py
            tests/gym/envs/test_swe_smith.py

  test-r2egym:
    name: "Testing R2E-Gym"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        language: [ "python" ]
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/test-if-changes
        with:
          name: r2egym
          test-files: "tests/gym/envs/test_r2egym.py"
          changed-files: |
            debug_gym/gym/envs/r2egym.py
            tests/gym/envs/test_r2egym.py

  tests:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        language: [ "python" ]
        os: [ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e '.[dev]'
      - name: Test - PR - Fast
        env:
          FORCE_DOCKER_TERMINAL: false
        run: |
          DEBUG_GYM_DEBUG=1 pytest -vv -n 16 -k "not test_swe_bench and not test_swe_smith and not test_r2egym" --cov=debug_gym --cov-report=term-missing --timeout=600
      - name: Store coverage report
        uses: actions/upload-artifact@v4
        with:
          name: .coverage-main
          path: .coverage
          if-no-files-found: error
          include-hidden-files: true

  report-coverage:
    runs-on: ubuntu-latest
    needs: [tests, test-swebench, test-swesmith, test-r2egym]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install coverage

      - name: Prepare coverage directory
        run: mkdir -p .coverage

      - name: Download main coverage
        uses: actions/download-artifact@v4
        with:
          name: .coverage-main
          path: .coverage

      # Uncomment these only after adding corresponding upload steps in those jobs
      - name: Download swebench coverage
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: .coverage-swebench
          path: .coverage

      - name: Download swesmith coverage
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: .coverage-swesmith
          path: .coverage

      - name: Download r2egym coverage
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: .coverage-r2egym
          path: .coverage

      - name: Combine and report coverage
        run: |
          ls -la .coverage
          coverage combine .coverage
          coverage report --fail-under=85